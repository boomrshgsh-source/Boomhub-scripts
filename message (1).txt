local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local Players, RunService, Camera, LocalPlayer, Mouse, UIS =
    game:GetService("Players"), game:GetService("RunService"),
    workspace.CurrentCamera, game.Players.LocalPlayer, game.Players.LocalPlayer:GetMouse(),
    game:GetService("UserInputService")

local Window = WindUI:CreateWindow({
    Title = "Nexus x dev",
    Icon = "rbxassetid://137877095538630",
    Author = "",
    Folder = "GotHubFolder",
    Size = UDim2.fromOffset(400, 200),
    Theme = "Dark",
    Transparent = true,
    Resizable = true,
})

--== SERVICES ==--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

--== VARIABLES ==--
local SilentAimEnabled = false
local WallbangEnabled = false
local FOVRadius = 150
local CurrentTarget = nil

--== DRAWINGS (FOV + TRACER) ==--
local FOVCircle = Drawing.new("Circle")
FOVCircle.Filled = false
FOVCircle.NumSides = 100
FOVCircle.Thickness = 2
FOVCircle.Visible = false

local Tracer = Drawing.new("Line")
Tracer.Thickness = 1
Tracer.Visible = false

--== ADVANCED PREDICTION + ANTI AIM BREAKER ==--
local function getTrueVelocity(hrp)
    if not hrp then return Vector3.zero end
    local vel = hrp.Velocity
    if vel.Magnitude > 180 then
        vel = vel.Unit * 180
    end
    return vel
end

local function getAcceleration(hrp)
    if not hrp then return Vector3.zero end
    local last = hrp:GetAttribute("_lastVel") or Vector3.zero
    local now = hrp.Velocity
    hrp:SetAttribute("_lastVel", now)
    return (now - last) * 0.15
end

local function superPredict(head, hrp)
    if not head or not hrp then return head.Position end
    local ping = game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue() / 1000
    if ping <= 0 then ping = 0.12 end
    local vel = getTrueVelocity(hrp)
    local accel = getAcceleration(hrp)
    local jumpBoost = Vector3.new(0, math.clamp(vel.Y, -18, 28) * ping, 0)
    return head.Position + (vel * ping * 1.4) + (accel * ping * 1.1) + jumpBoost
end

local function breakAntiAim(player)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    if hrp.AssemblyAngularVelocity.Magnitude > 18 then
        local vel = hrp.Velocity
        if vel.Magnitude > 2 then
            hrp.CFrame = CFrame.lookAt(hrp.Position, hrp.Position + vel)
        end
    end
end

--== FIND TARGET INSIDE FOV ==--
local function getClosestTarget()
    local closest, shortest = nil, FOVRadius
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            local pos, visible = Camera:WorldToViewportPoint(head.Position)
            if visible then
                local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                if dist <= shortest then
                    shortest = dist
                    closest = plr
                end
            end
        end
    end
    return closest
end

--== WALL CHECK ==--
local function behindWall(from, to)
    local ray = Ray.new(from, (to - from))
    local ignore = {LocalPlayer.Character}
    local hit = Workspace:FindPartOnRayWithIgnoreList(ray, ignore)
    return hit ~= nil
end

--== HOOK SHOOT ==--
local Remote = game.ReplicatedStorage:WaitForChild("Remotes").Send
local old; old = hookfunction(Remote.FireServer, function(self, ...)
    local args = {...}
    if self == Remote and args[2] == "shoot_gun" and CurrentTarget then
        breakAntiAim(CurrentTarget)
        local head = CurrentTarget.Character.Head
        local hrp = CurrentTarget.Character.HumanoidRootPart
        local myHead = LocalPlayer.Character.Head
        local aimPos = superPredict(head, hrp)
        if WallbangEnabled and behindWall(myHead.Position, aimPos) then
            args[4] = CFrame.new(math.huge, math.huge, math.huge)
        else
            args[4] = CFrame.new(myHead.Position, aimPos)
        end
        args[5] = {
            {
                {
                    Instance = head,
                    Normal = Vector3.new(0, 1, 0),
                    Position = aimPos
                }
            }
        }
    end
    return old(self, unpack(args))
end)

--== RENDER VISUALS (FOV + TRACER) ==--
local hueF = 0
RunService.RenderStepped:Connect(function()
    -- FOV Circle Gradient (Purple → Pink)
    hueF = (hueF + 0.008) % 1
    local purple = 0.78
    local pink   = 0.90
    local gradientF = purple + (pink - purple) * math.abs(math.sin(hueF * math.pi))

    FOVCircle.Color = Color3.fromHSV(gradientF,1,1)
    FOVCircle.Visible = SilentAimEnabled
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    FOVCircle.Radius = FOVRadius -- ใช้ค่า slider แบบ real-time

    -- Update Target
    CurrentTarget = SilentAimEnabled and getClosestTarget() or nil

    -- Update Tracer
    if CurrentTarget and CurrentTarget.Character and CurrentTarget.Character:FindFirstChild("Head") then
        local head = CurrentTarget.Character.Head
        local headPos, visible = Camera:WorldToViewportPoint(head.Position)
        if visible then
            Tracer.Visible = true
            Tracer.Color = Color3.fromHSV(gradientF,1,1)
            Tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
            Tracer.To = Vector2.new(headPos.X, headPos.Y)
        else
            Tracer.Visible = false
        end
    else
        Tracer.Visible = false
    end
end)

--== WINDUI TAB (TEST) ==--
local Tab_Test = Window:Tab({
    Title = "Test",
    Icon = "crosshair"
})

Tab_Test:Toggle({
    Title = "Silent Aim",
    Default = false,
    Callback = function(v)
        SilentAimEnabled = v
    end
})

Tab_Test:Toggle({
    Title = "Wallbang (GoodGun)",
    Default = false,
    Callback = function(v)
        WallbangEnabled = v
    end
})

Tab_Test:Slider({
    Title = "FOV Size",
    Min = 30,
    Max = 300,
    Default = 150,
    Callback = function(v)
        FOVRadius = tonumber(v) -- แก้ให้เป็น number แน่นอน
    end
})
