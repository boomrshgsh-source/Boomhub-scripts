-- ส่วนที่ 1: Basic Setup
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

local Camera = Workspace.CurrentCamera

-- ตัวแปรสถานะ
local SilentAimEnabled = false
local WallbangEnabled = false
local FOVRadius = 120
local CurrentTarget = nil
local TargetLockType = "Head" -- "Head" หรือ "HumanoidRootPart"

-- อาวุธที่รองรับ
local GunNames = {
    "AK47", "M4A1", "AWM", "Desert Eagle", "MP5", "Shotgun", "Vector"
}

local GunLookup = {}
for _, name in ipairs(GunNames) do
    GunLookup[name:lower()] = true
end
-- ส่วนที่ 2: ฟังก์ชันช่วยเหลือ
local function IsValidTarget(player)
    if player == LocalPlayer then return false end
    if not player.Character then return false end
    
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    
    if TargetLockType == "Head" then
        local head = player.Character:FindFirstChild("Head")
        if not head then return false end
    else
        local hrp = player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return false end
    end
    
    return true
end

local function GetTargetLockPosition(targetCharacter)
    if not targetCharacter then return nil end
    
    if TargetLockType == "Head" then
        local head = targetCharacter:FindFirstChild("Head")
        if head then
            return head.Position, head
        end
    else
        local hrp = targetCharacter:FindFirstChild("HumanoidRootPart")
        if hrp then
            return hrp.Position, hrp
        end
    end
    
    return nil
end

local function IsHoldingAllowedGun()
    if not LocalPlayer.Character then return false end
    
    for _, child in pairs(LocalPlayer.Character:GetChildren()) do
        if (child:IsA("Tool") or child:IsA("Model")) and GunLookup[child.Name:lower()] then
            return true
        end
    end
    
    return false
end

local function isBehindWall(startPos, endPos)
    if not startPos or not endPos then return false end
    local ray = Ray.new(startPos, (endPos - startPos).Unit * (endPos - startPos).Magnitude)
    local ignoreList = {LocalPlayer.Character}
    if CurrentTarget and CurrentTarget.Character then
        table.insert(ignoreList, CurrentTarget.Character)
    end
    local hit, position = Workspace:FindPartOnRayWithIgnoreList(ray, ignoreList)
    return hit ~= nil
end
-- ส่วนที่ 3: ระบบ Prediction
local AutoPrediction = {
    prevPrediction = 0.085,
    prevHorizontalVelocity = Vector3.new(0, 0, 0),
    
    GetHorizontalVelocity = function(self, velocity)
        return Vector3.new(velocity.X, 0, velocity.Z)
    end,
    
    IsActuallyMoving = function(self, humanoidRootPart)
        if not humanoidRootPart then return false end
        local velocity = humanoidRootPart.Velocity
        local horizontalVelocity = self:GetHorizontalVelocity(velocity)
        local character = humanoidRootPart.Parent
        local humanoid = character and character:FindFirstChildOfClass("Humanoid")
        
        if humanoid then
            local moveDirection = humanoid.MoveDirection
            local isMoving = moveDirection.Magnitude > 0.1
            local horizontalSpeed = horizontalVelocity.Magnitude
            return isMoving and horizontalSpeed > 2
        end
        
        return horizontalVelocity.Magnitude > 2
    end,
    
    Calculate = function(self, targetPosition, targetVelocity, distance, isActuallyMoving)
        local basePred = 0.085
        local maxSpeed = 25
        local maxDist = 350

        local horizontalVelocity = self:GetHorizontalVelocity(targetVelocity)
        local speed = horizontalVelocity.Magnitude
        
        local speedFactor = 0
        if isActuallyMoving then
            speedFactor = math.clamp(speed / maxSpeed, 0, 1)
        else
            speedFactor = math.clamp(speed / 5, 0, 0.2)
        end

        local distFactor = math.clamp(distance / maxDist, 0, 1)

        local accel = (horizontalVelocity - self.prevHorizontalVelocity).Magnitude
        local accelFactor = math.clamp(accel / 15, 0, 1)
        self.prevHorizontalVelocity = horizontalVelocity

        local prediction = basePred
        
        if isActuallyMoving and speed > 3 then
            prediction = prediction + speedFactor * 0.045
        end
        
        prediction = prediction + distFactor * 0.025
        prediction = prediction + accelFactor * 0.015

        self.prevPrediction = prediction
        return math.clamp(prediction, 0.05, 0.15)
    end,
    
    GetPredictedPosition = function(self, pos, vel, distance, isActuallyMoving)
        local pred = self:Calculate(pos, vel, distance, isActuallyMoving)
        return pos + vel * pred, pred
    end
}
-- ส่วนที่ 4: Target Selection
local cachedPlayers = {}
local lastTargetUpdate = 0
local cachedTarget = nil

local function UpdatePlayerCache()
    cachedPlayers = {}
    for _, player in pairs(Players:GetPlayers()) do
        if IsValidTarget(player) then
            table.insert(cachedPlayers, player)
        end
    end
    return cachedPlayers
end

local function GetClosestTarget()
    local currentTime = tick()
    
    if currentTime - lastTargetUpdate > 0.05 then
        UpdatePlayerCache()
        lastTargetUpdate = currentTime
        cachedTarget = nil
    end
    
    if cachedTarget and IsValidTarget(cachedTarget) then
        return cachedTarget
    end
    
    local closest = nil
    local shortestDistance = FOVRadius
    local center = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    
    for _, player in ipairs(cachedPlayers) do
        if player ~= LocalPlayer and player.Character then
            local targetPart = nil
            
            if TargetLockType == "Head" then
                targetPart = player.Character:FindFirstChild("Head")
            else
                targetPart = player.Character:FindFirstChild("HumanoidRootPart")
            end
            
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            
            if targetPart and humanoid and humanoid.Health > 0 then
                local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                if onScreen then
                    local screenVector = Vector2.new(screenPos.X, screenPos.Y)
                    local distanceFromCenter = (screenVector - center).Magnitude
                    
                    if distanceFromCenter <= FOVRadius then
                        if distanceFromCenter < shortestDistance then
                            shortestDistance = distanceFromCenter
                            closest = player
                        end
                    end
                end
            end
        end
    end
    
    cachedTarget = closest
    return closest
end
-- ส่วนที่ 5: Hook FireServer
local send = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Send")
local oldFire

oldFire = hookfunction(send.FireServer, function(self, ...)
    local args = {...}
    
    if (SilentAimEnabled or WallbangEnabled) and IsHoldingAllowedGun() then
        local target = GetClosestTarget()
        if target and target.Character then
            local lockPosition, lockPart = GetTargetLockPosition(target.Character)
            local humanoidRootPart = target.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
            
            if lockPosition and humanoidRootPart and humanoid and humanoid.Health > 0 then
                local distance = (lockPosition - Camera.CFrame.Position).Magnitude
                local isActuallyMoving = AutoPrediction:IsActuallyMoving(humanoidRootPart)
                local aimPos, predictionUsed = AutoPrediction:GetPredictedPosition(
                    lockPosition,
                    humanoidRootPart.Velocity,
                    distance,
                    isActuallyMoving
                )
                
                local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
                local isTargetBehindWall = false
                
                if myHead then
                    isTargetBehindWall = isBehindWall(myHead.Position, aimPos)
                end
                
                -- ระบบ Wallbang
                if WallbangEnabled and isTargetBehindWall then
                    args[4] = CFrame.new(math.huge, math.huge, math.huge)
                    args[5] = {
                        [1] = {
                            [1] = {
                                ["Instance"] = lockPart,
                                ["Normal"] = Vector3.new(0, 1, 0),
                                ["Position"] = aimPos
                            }
                        }
                    }
                else
                    args[4] = CFrame.new(LocalPlayer.Character.Head.Position, aimPos)
                    args[5] = {
                        [1] = {
                            [1] = {
                                ["Instance"] = lockPart,
                                ["Normal"] = Vector3.new(0, 1, 0),
                                ["Position"] = aimPos
                            }
                        }
                    }
                end
            end
        end
    end
    
    return oldFire(self, unpack(args))
end)
-- ส่วนที่ 6: Visuals
local tracerLine = Drawing.new("Line")
tracerLine.Color = Color3.fromRGB(255, 50, 50)
tracerLine.Thickness = 2
tracerLine.Visible = false

local crosshair = Drawing.new("Circle")
crosshair.Color = Color3.fromRGB(255, 0, 0)
crosshair.Thickness = 2
crosshair.Radius = 6
crosshair.Filled = false
crosshair.Visible = false

RunService.RenderStepped:Connect(function()
    if not SilentAimEnabled and not WallbangEnabled then
        tracerLine.Visible = false
        crosshair.Visible = false
        return
    end
    
    local target = GetClosestTarget()
    CurrentTarget = target
    
    if target and target.Character then
        local lockPosition = GetTargetLockPosition(target.Character)
        local humanoidRootPart = target.Character:FindFirstChild("HumanoidRootPart")
        
        if lockPosition and humanoidRootPart then
            local distance = (lockPosition - Camera.CFrame.Position).Magnitude
            local isActuallyMoving = AutoPrediction:IsActuallyMoving(humanoidRootPart)
            local predictedPos, predictionUsed = AutoPrediction:GetPredictedPosition(
                lockPosition,
                humanoidRootPart.Velocity,
                distance,
                isActuallyMoving
            )
            
            local screenPos, onScreen = Camera:WorldToViewportPoint(predictedPos)
            
            if onScreen then
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") then
                    local ourHead = LocalPlayer.Character.Head
                    local screenStart = Camera:WorldToViewportPoint(ourHead.Position)
                    tracerLine.From = Vector2.new(screenStart.X, screenStart.Y)
                    tracerLine.To = Vector2.new(screenPos.X, screenPos.Y)
                    
                    if WallbangEnabled then
                        local isTargetBehindWall = isBehindWall(ourHead.Position, predictedPos)
                        tracerLine.Color = isTargetBehindWall and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 50, 50)
                    else
                        tracerLine.Color = Color3.fromRGB(255, 50, 50)
                    end
                    
                    tracerLine.Visible = true
                end
                
                crosshair.Position = Vector2.new(screenPos.X, screenPos.Y)
                crosshair.Visible = true
            else
                tracerLine.Visible = false
                crosshair.Visible = false
            end
        else
            tracerLine.Visible = false
            crosshair.Visible = false
        end
    else
        tracerLine.Visible = false
        crosshair.Visible = false
    end
end)
-- ส่วนที่ 7: UI Interface
local Window = WindUI:CreateWindow({
    Title = "Silent Aim & Wallbang",
    Size = UDim2.fromOffset(400, 350),
    Theme = "Dark",
    KeyCode = Enum.KeyCode.G
})

local MainTab = Window:Tab({Title = "Main"})

MainTab:Section({Title = "Activation"})

local silentAimToggle = MainTab:Toggle({
    Title = "Silent Aim",
    Value = false,
    Callback = function(v)
        SilentAimEnabled = v
        if v and WallbangEnabled then
            WallbangEnabled = false
        end
    end
})

local wallbangToggle = MainTab:Toggle({
    Title = "Wallbang",
    Value = false,
    Callback = function(v)
        WallbangEnabled = v
        if v and SilentAimEnabled then
            SilentAimEnabled = false
        end
    end
})

MainTab:Section({Title = "Target Lock"})

local headLockToggle = MainTab:Toggle({
    Title = "Lock Head",
    Value = TargetLockType == "Head",
    Callback = function(v)
        if v then
            TargetLockType = "Head"
        end
    end
})

local bodyLockToggle = MainTab:Toggle({
    Title = "Lock HumanoidRootPart",
    Value = TargetLockType == "HumanoidRootPart",
    Callback = function(v)
        if v then
            TargetLockType = "HumanoidRootPart"
        end
    end
})

MainTab:Section({Title = "Settings"})

MainTab:Slider({
    Title = "FOV Radius",
    Step = 5,
    Value = {
        Min = 50,
        Max = 300,
        Default = FOVRadius
    },
    Callback = function(value)
        FOVRadius = tonumber(value) or 120
    end
})

print("Silent Aim & Wallbang Loaded!")
print("Press G to open/close UI")
